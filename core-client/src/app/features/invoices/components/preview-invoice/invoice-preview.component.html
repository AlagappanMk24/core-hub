<div class="actions-container" @fadeIn>
  <div class="actions">
    <button mat-raised-button (click)="onClose()" aria-label="Close preview">
      <mat-icon>close</mat-icon> Close
    </button>
  </div>
</div>

<div class="invoice-view-container" *ngIf="!isLoading; else loadingSpinner" @fadeIn>
  <div class="invoice-content">
    <!-- Header Section -->
    <div class="header">
      <div class="company-info">
        <h2>{{ company?.name || 'KL Infotech' }}</h2>
        <p class="tagline">OUR FOCUS, YOUR FUTURE</p>
        <p>{{ company?.address?.address1 || 'Besant Nagar, Chennai 45' }}</p>
        <p>{{ company?.address?.city || '' }}, {{ company?.address?.state || '' }} {{ company?.address?.zipCode || '' }}</p>
        <p *ngIf="company?.address?.country">{{ company?.address?.country }}</p>
        <p>{{ company?.email || 'support@klinfotech.com' }}</p>
      </div>
      <div class="invoice-info">
        <h1>INVOICE</h1>
        <p>Invoice No. #{{ invoice?.invoiceNumber || 'N/A' }}</p>
        <p>Issue Date: {{ invoice?.issueDate | date:'dd MMM yyyy' }}</p>
        <p>Due Date: {{ invoice?.dueDate | date:'dd MMM yyyy' }}</p>
      </div>
    </div>
    <hr class="divider">

    <!-- Customer Info -->
    <div class="customer-info">
      <h3>Bill To:</h3>
      <p class="customer-name">{{ invoice?.customer?.name || 'Customer Name' }}</p>
      <p>{{ invoice?.customer?.address?.address1 || '' }} {{ invoice?.customer?.address?.address2 || '' }}</p>
      <p>{{ invoice?.customer?.address?.city || '' }}, {{ invoice?.customer?.address?.state || '' }} {{ invoice?.customer?.address?.zipCode || '' }}</p>
      <p *ngIf="invoice?.customer?.address?.country">{{ invoice?.customer?.address?.country }}</p>
      <p>
        <span *ngIf="invoice?.customer?.email">Email: {{ invoice?.customer?.email }}</span>
        <span *ngIf="invoice?.customer?.phoneNumber" [ngStyle]="{'margin-left': invoice.customer.email ? '1rem' : '0'}">
          {{ invoice?.customer?.email ? '|' : '' }} Phone: {{ invoice.customer.phoneNumber }}
        </span>
      </p>
      <div class="total-box">
        <p>Total Amount</p>
        <p class="total-amount">{{ invoice.totalAmount | currency:invoice.currency || 'USD' }}</p>
      </div>
    </div>

    <!-- Items Table -->
    <div class="items-table">
      <table>
        <thead>
          <tr>
            <th>Item Description</th>
            <th>Usage Period</th>
            <th>Qty</th>
            <th>Unit Price</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of invoice?.items; let i = index" [ngClass]="{'alternate-row': i % 2 === 0}">
            <td>{{ item.description || 'N/A' }}</td>
            <td>Monthly</td>
            <td>{{ item.quantity }}</td>
            <td>{{ item.unitPrice | currency:invoice.currency || 'USD' }}</td>
            <td>{{ item.amount | currency:invoice.currency || 'USD' }}</td>
          </tr>
          <tr *ngIf="!invoice?.items?.length">
            <td colspan="5">No items available.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Payment Method -->
    <div class="payment-method" *ngIf="invoice?.paymentMethod">
      <h3>Payment Method</h3>
      <p>{{ invoice.paymentMethod }}</p>
    </div>

    <!-- Summary Section -->
    <div class="summary">
      <div class="summary-box">
        <div class="summary-item">
          <span>Sub Total:</span>
          <span>{{ invoice.subtotal | currency:invoice.currency || 'USD' }}</span>
        </div>
        <ng-container *ngFor="let tax of invoice?.taxDetails">
          <div class="summary-item">
            <span>Tax ({{ tax.rate }}%):</span>
            <span>{{ tax.amount | currency:invoice.currency || 'USD' }}</span>
          </div>
        </ng-container>
        <ng-container *ngFor="let discount of invoice?.discounts">
          <div class="summary-item discount">
            <span>{{ discount.isPercentage ? 'Discount (' + discount.amount + '%)' : 'Discount' }}:</span>
            <span>-{{ discount.amount| currency:invoice.currency || 'USD' }}</span>
          </div>
        </ng-container>
        <hr class="summary-divider">
        <div class="summary-item total">
          <span>Total:</span>
          <span>{{ invoice.totalAmount | currency:invoice.currency || 'USD' }}</span>
        </div>
      </div>
    </div>

    <!-- Terms & Conditions -->
    <div class="terms">
      <h3>Terms & Conditions</h3>
      <p>{{ invoice.notes || 'Thank you for your business! Payment is due within 30 days of invoice date.' }}</p>
    </div>

    <!-- Rectangular Footer -->
    <div class="wave-footer">
      <svg viewBox="0 0 500 60" preserveAspectRatio="none">
        <rect x="0" y="0" width="500" height="30" fill="#a78bfa"></rect>
      </svg>
    </div>
  </div>
</div>

<ng-template #loadingSpinner>
  <div class="loading-container" @fadeIn>
    <mat-spinner diameter="50" color="accent"></mat-spinner>
  </div>
</ng-template>